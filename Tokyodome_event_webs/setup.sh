#!/bin/bash

# ==============================================================================
# Raspberry Pi GUIã‚¢ãƒ—ãƒªè‡ªå‹•èµ·å‹•ç’°å¢ƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ==============================================================================

# --- å¤‰æ•°è¨­å®š (ç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ãã ã•ã„) ---
# ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼å
USERNAME="rasp4"
# Pythonãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒç½®ã‹ã‚Œã¦ã„ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ•ãƒ«ãƒ‘ã‚¹
PROJECT_DIR="/home/${USERNAME}/Documents/Tokyodome_event_webs"


# --- ã‚¹ã‚¯ãƒªãƒ—ãƒˆæœ¬ä½“ ---
echo "âœ… Raspberry Pi GUIã‚¢ãƒ—ãƒªè‡ªå‹•èµ·å‹•ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¾ã™..."
echo "å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼: ${USERNAME}"
echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: ${PROJECT_DIR}"
echo ""

# 1. OSãƒ¬ãƒ™ãƒ«ã®æº–å‚™
echo "------------------------------------------------------------"
echo "ã‚¹ãƒ†ãƒƒãƒ—1: OSãƒ¬ãƒ™ãƒ«ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨è¨­å®š"
echo "------------------------------------------------------------"

echo "[1/2] å¿…è¦ãªã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™..."
sudo apt-get update
sudo apt-get install -y python3-pip chromium-browser chromium-chromedriver
echo "â†’ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
echo ""

echo "[2/2] æ—¥æœ¬èªžãƒ­ã‚±ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ–ã—ã¦ã„ã¾ã™..."
sudo sed -i -e 's/# ja_JP.UTF-8 UTF-8/ja_JP.UTF-8 UTF-8/' /etc/locale.gen
sudo locale-gen
echo "â†’ æ—¥æœ¬èªžãƒ­ã‚±ãƒ¼ãƒ«ã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
echo ""


# 2. Pythonãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
echo "------------------------------------------------------------"
echo "ã‚¹ãƒ†ãƒƒãƒ—2: Pythonãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä»®æƒ³ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™"
echo "------------------------------------------------------------"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
if [ ! -d "${PROJECT_DIR}" ]; then
    echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ä½œæˆã—ã¾ã™: ${PROJECT_DIR}"
    mkdir -p "${PROJECT_DIR}"
fi
cd "${PROJECT_DIR}"

echo "[1/2] Pythonä»®æƒ³ç’°å¢ƒ (venv) ã‚’ä½œæˆã—ã¦ã„ã¾ã™..."
python3 -m venv venv
echo "â†’ ä»®æƒ³ç’°å¢ƒã‚’ä½œæˆã—ã¾ã—ãŸã€‚"
echo ""

echo "[2/2] å¿…è¦ãªPythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä»®æƒ³ç’°å¢ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™..."
# activateã›ãšã«ã€ä»®æƒ³ç’°å¢ƒå†…ã®pipã‚’ç›´æŽ¥å‘¼ã³å‡ºã™
./venv/bin/pip install selenium requests beautifulsoup4
echo "â†’ Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
echo ""


# 3. systemdã«ã‚ˆã‚‹è‡ªå‹•èµ·å‹•è¨­å®š
echo "------------------------------------------------------------"
echo "ã‚¹ãƒ†ãƒƒãƒ—3: systemdã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œæˆã—ã¦è‡ªå‹•èµ·å‹•ã‚’è¨­å®šã—ã¾ã™"
echo "------------------------------------------------------------"

echo "[1/2] systemdã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã„ã¾ã™..."
# teeã‚³ãƒžãƒ³ãƒ‰ã‚’ä½¿ã£ã¦rootæ¨©é™ã§ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã‚€
sudo tee /etc/systemd/system/tokyodome-gui.service > /dev/null <<EOF
[Unit]
Description=Tokyo Dome Event GUI (System Service)
After=graphical.target

[Service]
User=${USERNAME}
Environment=DISPLAY=:0
Environment=XAUTHORITY=/home/${USERNAME}/.Xauthority
ExecStartPre=/bin/sleep 15
ExecStart=${PROJECT_DIR}/venv/bin/python ${PROJECT_DIR}/gui.py
WorkingDirectory=${PROJECT_DIR}
RuntimeMaxSec=8h
Restart=always
RestartSec=10

[Install]
WantedBy=graphical.target
EOF
echo "â†’ ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ: /etc/systemd/system/tokyodome-gui.service"
echo ""

echo "[2/2] systemdã‚µãƒ¼ãƒ“ã‚¹ã‚’æœ‰åŠ¹åŒ–ã—ã¦ã„ã¾ã™..."
sudo systemctl daemon-reload
sudo systemctl enable tokyodome-gui.service
echo "â†’ ã‚µãƒ¼ãƒ“ã‚¹ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸã€‚"
echo ""


# å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
echo "------------------------------------------------------------"
echo "ðŸŽ‰ å…¨ã¦ã®è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
echo "------------------------------------------------------------"
echo ""
echo "æ¬¡ã«ã€ä»¥ä¸‹ã®ã€æ‰‹å‹•ã§ã®Pythonã‚³ãƒ¼ãƒ‰ä¿®æ­£ã€‘ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"
echo "ãã‚ŒãŒå®Œäº†ã—ãŸã‚‰ã€Raspberry Piã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„: sudo reboot"
echo ""